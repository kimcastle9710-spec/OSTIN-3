import rclpy
from rclpy.node import Node
from std_msgs.msg import String
import serial
import time
import threading

# =========================================================
# [ì„¤ì •] ì•„ë‘ì´ë…¸ í¬íŠ¸ (ìš°ë¶„íˆ¬ì—ì„œëŠ” ë³´í†µ /dev/ttyUSB0 ë“±)
# =========================================================
SERIAL_PORT = '/dev/ttyUSB0' 
BAUD_RATE = 115200

class ArmController(Node):
    def __init__(self):
        super().__init__('arm_controller')
        
        # 1. ì‹œë¦¬ì–¼ ì—°ê²°
        try:
            self.ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=1)
            self.get_logger().info(f'âœ… Serial Connected to {SERIAL_PORT}')
            time.sleep(2) # ì•„ë‘ì´ë…¸ ë¦¬ì…‹ ëŒ€ê¸°
        except Exception as e:
            self.get_logger().error(f'âŒ Serial Connection Failed: {e}')
            exit()

        # 2. Publisher (ë¡œë´‡íŒ” ìƒíƒœ -> AGV)
        # í† í”½ ì´ë¦„: /arm/status
        # ë©”ì‹œì§€: "GRIPPED" (ìž¡ìŒ), "RELEASED" (ë†“ìŒ)
        self.publisher_ = self.create_publisher(String, '/arm/status', 10)

        # 3. Subscriber (AGV ìƒíƒœ -> ë¡œë´‡íŒ”)
        # í† í”½ ì´ë¦„: /agv/status
        # ë©”ì‹œì§€: "ARRIVED_PICK" (1ë²ˆ ê²½ìœ ì§€), "ARRIVED_PLACE" (2ë²ˆ ê²½ìœ ì§€)
        self.subscription = self.create_subscription(
            String,
            '/agv/status',
            self.listener_callback,
            10)
        
        # 4. ì‹œë¦¬ì–¼ ìˆ˜ì‹  ìŠ¤ë ˆë“œ ì‹œìž‘
        self.running = True
        self.serial_thread = threading.Thread(target=self.serial_reader)
        self.serial_thread.daemon = True
        self.serial_thread.start()

        self.get_logger().info('ðŸ¤– Arm Controller Node is Ready!')

    def listener_callback(self, msg):
        command = msg.data
        self.get_logger().info(f'ðŸ“© Received from AGV: "{command}"')

        if command == "ARRIVED_PICK":
            self.get_logger().info('ðŸš€ Starting PICK Sequence...')
            self.send_serial("SEQ:PICK")
            
        elif command == "ARRIVED_PLACE":
            self.get_logger().info('ðŸš€ Starting RELEASE Sequence...')
            self.send_serial("SEQ:RELEASE")
            
        else:
            self.get_logger().warn(f'Unknown command: {command}')

    def send_serial(self, cmd):
        if self.ser and self.ser.is_open:
            self.ser.write((cmd + '\n').encode())

    def serial_reader(self):
        """ì•„ë‘ì´ë…¸ë¡œë¶€í„° ì™„ë£Œ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¼"""
        while self.running:
            if self.ser and self.ser.in_waiting:
                try:
                    line = self.ser.readline().decode('utf-8').strip()
                    
                    # ì•„ë‘ì´ë…¸ê°€ "DONE:PICK" ì´ë¼ê³  ë³´ë‚´ë©´ -> ROS2ë¡œ "GRIPPED" ë°œí–‰
                    if line == "DONE:PICK":
                        self.get_logger().info('âœ… Pick Action Completed!')
                        msg = String()
                        msg.data = "GRIPPED"
                        self.publisher_.publish(msg)
                        self.get_logger().info(f'ðŸ“¤ Published to AGV: "{msg.data}"')

                    # ì•„ë‘ì´ë…¸ê°€ "DONE:RELEASE" ë¼ê³  ë³´ë‚´ë©´ -> ROS2ë¡œ "RELEASED" ë°œí–‰
                    elif line == "DONE:RELEASE":
                        self.get_logger().info('âœ… Release Action Completed!')
                        msg = String()
                        msg.data = "RELEASED"
                        self.publisher_.publish(msg)
                        self.get_logger().info(f'ðŸ“¤ Published to AGV: "{msg.data}"')
                        
                    # ê·¸ ì™¸ ë””ë²„ê¹… ë©”ì‹œì§€
                    else:
                        # self.get_logger().info(f'[Arduino] {line}')
                        pass
                        
                except Exception as e:
                    self.get_logger().error(f'Serial Read Error: {e}')
            time.sleep(0.01)

def main(args=None):
    rclpy.init(args=args)
    node = ArmController()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
